{% extends 'base.html' %}

{% block content %}
<div class="grid-2">
    <!-- Stats Section -->
    <div class="glass-card" style="display: flex; flex-direction: column;">
        <label class="field-label" style="color: var(--text-secondary);">Repair Overview</label>
        <div style="display: flex; gap: 30px; margin-top: auto; padding-bottom: 10px;">
            <div style="text-align: left;">
                <h2 style="color: var(--accent-cyan); font-size: 2.5rem; line-height: 1;">{{ in_progress }}</h2>
                <span
                    style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim);">In
                    Progress</span>
            </div>
            <div style="text-align: left;">
                <h2 style="color: var(--accent-purple); font-size: 2.5rem; line-height: 1;">{{ total }}</h2>
                <span
                    style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim);">Total
                    Units</span>
            </div>
        </div>
    </div>

    <div class="glass-card" style="display: flex; flex-direction: column;">
        <label class="field-label" style="color: var(--text-secondary);">Unit Intake / Search</label>
        <div style="margin-top: auto; width: 100%;">
            <p style="color: var(--text-dim); font-size: 0.85rem; margin-bottom: 12px; text-align: left;">Scan or enter
                serial to open unit profile</p>
            <div style="display: flex; gap: 10px; align-items: stretch;">
                <div style="flex-grow: 1;">
                    <div class="input-with-icon">
                        <input type="text" id="manual-barcode" placeholder="Barcode / Serial..."
                            style="margin-bottom: 0; height: 42px;"
                            onkeydown="if(event.key === 'Enter') { event.preventDefault(); handleScan(); }">
                        <button type="button" id="qwerty-toggle" class="icon-toggle active" title="Toggle QWERTY fix"
                            onclick="toggleQwertyFix()">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17c-.71 2.06-1.74 3.99-3.13 5.67-1.12-1.35-1.98-2.79-2.57-4.32L4.49 7.33c.71 2.19 1.84 4.25 3.39 6.09l-4.42 4.41L4.88 19.3l4.41-4.41 2.52 2.52 1.06-2.34zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <button id="go-btn" onclick="handleScan()" class="btn btn-primary"
                    style="height: 42px; padding: 0 25px;">GO</button>
            </div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 20px;">
    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--card-border);">
        <h2 style="margin: 0; color: var(--accent-cyan); font-size: 1.2rem; letter-spacing: 1px;">ACTIVE REPAIR QUEUE
        </h2>
        <div class="input-with-icon" style="width: 280px;">
            <input type="text" id="searchInput" placeholder="Universal filter..."
                style="margin-bottom: 0; padding: 10px 15px; border-radius: 20px; font-size: 0.9rem;">
        </div>
    </div>

    <table id="unitsTable">
        <thead>
            <tr>
                <th style="width: 80px; cursor: pointer;" onclick="sortTable(0)">Label</th>
                <th style="width: 120px; cursor: pointer;" onclick="sortTable(1)">Barcode</th>
                <th style="width: 150px; cursor: pointer;" onclick="sortTable(2)">Model</th>
                <th style="cursor: pointer;" onclick="sortTable(3)">Issue</th>
                <th style="cursor: pointer;" onclick="sortTable(4)">Condition / Pins</th>
                <th style="width: 100px; cursor: pointer;" onclick="sortTable(5)">Status</th>
                <th style="width: 150px; cursor: pointer;" onclick="sortTable(6)">Last Update</th>
                <th style="width: 80px;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for unit in units %}
            <tr onclick="navigateToUnit('{{ unit.barcode }}')" style="cursor: pointer;">
                <td style="font-weight: bold; color: var(--accent-purple);">{{ unit.label if unit.label else '-' }}</td>
                <td style="font-family: monospace; color: var(--accent-cyan);">{{ unit.barcode }}</td>
                <td>
                    {{ unit.model }}
                    {% if unit.patch_status and unit.patch_status != 'Unknown' %}
                    {% set p_color = 'var(--text-dim)' %}
                    {% if 'Unpatched' in unit.patch_status %}{% set p_color = 'var(--accent-green)' %}
                    {% elif 'Warning' in unit.patch_status %}{% set p_color = 'var(--accent-yellow)' %}
                    {% elif 'Patched' in unit.patch_status %}{% set p_color = 'var(--accent-red)' %}
                    {% endif %}
                    <div
                        style="font-size: 0.7rem; color: {{ p_color }}; font-weight: 800; letter-spacing: 0.5px; opacity: 0.8;">
                        {{ unit.patch_status.upper() }}
                    </div>
                    {% endif %}
                </td>
                <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                    title="{{ unit.issue }}">
                    {{ unit.issue }}
                    <!-- Hidden span for search filter to find notes/condition/owner -->
                    <span style="display:none;">{{ unit.owner }} {{ unit.notes }} {{ unit.condition_notes }} {{
                        unit.model }} {{
                        unit.patch_status }}</span>
                </td>
                <td style="max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-soft);"
                    title="{{ unit.condition_notes }}">

                    <!-- Visual Pin Check Logic -->
                    {% if unit.pin_check %}
                    {% if unit.pin_check.startswith('{') %}
                    <span class="pin-summary" data-json='{{ unit.pin_check }}' data-type="{{ unit.type }}"
                        style="font-size: 0.8rem; margin-right: 5px;"></span>
                    {% else %}
                    <span style="font-size: 0.8rem; color: var(--text-dim); margin-right: 5px;">PIN: {{ unit.pin_check
                        }}</span>
                    {% endif %}
                    {% endif %}

                    {{ unit.condition_notes if unit.condition_notes else '' }}
                </td>
                <td>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <span class="status-badge status-{{ unit.status.lower().replace(' ', '-') }}">
                            {{ unit.status }}
                        </span>
                        {% if unit.modchip %}
                        <span class="status-badge status-modchip">
                            {{ unit.modchip }}
                        </span>
                        {% endif %}
                    </div>
                </td>
                <td style="font-size: 0.8rem; color: var(--text-secondary);">{{ unit.updated_at[:16] }}</td>
                <td>
                    <a href="/unit/{{ unit.barcode }}" class="btn btn-sm btn-accent-cyan">VIEW</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    No units found. Scan a barcode to get started.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='dashboard.js') }}"></script>
{% endblock %}