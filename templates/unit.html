{% extends 'base.html' %}

{% block head %}
<style>
    #modchip-type:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="unit-nav-bar">
    <a href="/" class="btn">&larr; Back to Dashboard</a>
</div>

<div class="glass-card">
    <form method="POST">
        <div class="unit-header-container">
            <div>
                <h1 class="barcode-text">{{ barcode }}</h1>
                <div class="registration-info">
                    {% if unit and unit.patch_status %}
                    {% set status_class = 'security-badge unknown' %}
                    {% if unit.patch_status == 'Unpatched' %}{% set status_class = 'security-badge unpatched' %}
                    {% elif unit.patch_status == 'Patched' %}{% set status_class = 'security-badge patched' %}{% endif
                    %}
                    <span class="{{ status_class }}">
                        {{ unit.patch_status.upper() }}
                    </span>
                    {% endif %}
                    <span>
                        {% if unit %}
                        Registered: {{ unit.created_at }}
                        {% else %}
                        Draft Entry
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="header-actions">
                <!-- Status tag removed to avoid redundancy with footer dropdown -->
                <button type="submit" class="btn btn-primary" style="font-size: 1rem; padding: 12px 30px;">
                    {% if unit and unit.id %}Update Unit{% else %}Register Unit{% endif %}
                </button>
            </div>
        </div>
        <div class="grid-2">
            <!-- Left Column: Unit Identity & Active Triage -->
            <div>
                <!-- Identity Group -->
                <div class="diagnosis-section identity-section">
                    <div class="diagnosis-section-title identity-header">
                        <span>UNIT IDENTITY</span>
                    </div>

                    <div class="identity-grid">
                        <div class="form-group mb-0">
                            <label class="field-label">Board Label / ID</label>
                            <div class="label-row">
                                <input type="text" name="label" id="labelInput"
                                    value="{{ unit['label'] if unit and unit['label'] else '' }}"
                                    placeholder="e.g. SW001" class="mb-0 flex-1">
                                <button type="button" class="btn btn-sm btn-accent-purple"
                                    onclick="autoLabel()">AUTO</button>
                            </div>
                        </div>
                        <div class="form-group mb-0">
                            <label class="field-label">Owner / Source</label>
                            <input type="text" name="owner" placeholder="Owner or Source"
                                value="{{ unit.owner if unit and unit.owner else '' }}" class="mb-0">
                        </div>
                        <div class="form-group mb-0">
                            <label class="field-label">Device Model</label>
                            <div class="model-row">
                                <select name="type" class="flex-1 mb-0">
                                    <option value="Console" {% if not unit or unit.type=='Console' %}selected{% endif
                                        %}>Console</option>
                                    <option value="Dock" {% if unit and unit.type=='Dock' %}selected{% endif %}>Dock
                                    </option>
                                    <option value="Accessory" {% if unit and unit.type=='Accessory' %}selected{% endif
                                        %}>Accessory</option>
                                </select>
                                <input type="text" name="model" value="{{ unit.model if unit else 'Nintendo Switch' }}"
                                    placeholder="e.g. Switch V2" class="flex-2 mb-0">
                            </div>
                        </div>
                        <div class="form-group mb-0">
                            <label class="field-label">Reported Issue</label>
                            <input type="text" name="issue" value="{{ unit.issue if unit and unit.issue else '' }}"
                                placeholder="Fault symptom" class="mb-0">
                        </div>
                    </div>


                </div>

                <!-- Diagnostic Suite -->
                <!-- USB-C Pin Check -->
                <div class="diagnosis-section">
                    <div class="diagnosis-section-title">
                        <span>USB-C PIN CHECK</span>
                        <div class="pin-actions">
                            <button type="button" class="btn btn-sm btn-accent-green" onclick="setAllPinsGood()">SET
                                GOOD</button>
                            <button type="button" id="toggle-grid-btn" class="btn btn-sm"
                                onclick="togglePinTester()">OPEN CHECKER</button>
                        </div>
                    </div>

                    <input type="hidden" name="pin_check" id="pin_check_input"
                        value="{{ unit.pin_check if unit and unit.pin_check else '' }}">

                    <div id="pin-summary" class="pin-summary-box">
                        <span class="text-dim-small">No pin data</span>
                    </div>

                    <!-- Visual Grid (Hidden by default) -->
                    <div id="visual-pin-tester" class="visual-pin-tester" style="display: none;">
                        <div class="tester-header">
                            <span class="tester-title">MECHANIC TESTER MODE</span>
                        </div>

                        <div class="pin-grid-columns">
                            <!-- Side A -->
                            <div class="pin-column">
                                {% set pin_labels_a = {1:'GND', 2:'TX1+', 3:'TX1-', 4:'VBUS', 5:'CC1', 6:'D+', 7:'D-',
                                8:'SBU1', 9:'VBUS', 10:'RX2-', 11:'RX2+', 12:'GND'} %}
                                {% for i in range(1, 13) %}
                                <div class="pin-row">
                                    <div class="pin-label-group">
                                        <span class="pin-num">{% if i < 10 %}0{% endif %}{{i}}</span>
                                                <span class="pin-name">{{ pin_labels_a[i] }}</span>
                                    </div>
                                    <input type="text" class="pin-input pin-input-right" data-pin="{{i}}" maxlength="5"
                                        placeholder="---">
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Side B -->
                            <div class="pin-column">
                                {% set pin_labels_b = {13:'GND', 14:'RX1+', 15:'RX1-', 16:'VBUS', 17:'SBU2', 18:'D-',
                                19:'D+', 20:'CC2', 21:'VBUS', 22:'TX2-', 23:'TX2+', 24:'GND'} %}
                                {% for i in range(13, 25) %}
                                <div class="pin-row">
                                    <input type="text" class="pin-input pin-input-left" data-pin="{{i}}" maxlength="5"
                                        placeholder="---">
                                    <div class="pin-label-group">
                                        <span class="pin-name text-right">{{ pin_labels_b[i] }}</span>
                                        <span class="pin-num text-right">{{i}}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Automated Pin Diagnosis Result (Hidden by default) -->
                <div id="auto-diagnosis-result" class="diagnosis-card"
                    style="display: none; margin-top: 15px; border-left: 4px solid var(--accent-orange);">
                    <div class="diagnosis-header"
                        style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-bottom: 10px;">
                        <span class="diagnosis-title" style="color: var(--accent-orange);">⚠️ PIN ANALYSIS
                            FINDINGS</span>
                    </div>
                    <div id="diagnosis-text" style="color: var(--text-primary); font-size: 0.9rem; line-height: 1.5;">
                    </div>
                </div>

                <!-- Port Reading -->
                <div class="diagnosis-section">
                    <div class="diagnosis-section-title"><span>PORT READING (INITIAL)</span></div>
                    <div class="form-group mb-0">
                        <label class="field-label sub">NO BATTERY IDLE MEASUREMENT</label>
                        <div class="port-reading-inputs">
                            <input type="text" name="usb_c_reading" id="usb_c_input"
                                value="{{ unit['usb_c_reading'] if unit and unit['usb_c_reading'] else '' }}"
                                placeholder="e.g. 15V/0.45A" class="mb-0 flex-1">
                            <button type="button" class="btn btn-sm btn-diag-analyze"
                                onclick="analyzePortReading()">ANALYZE</button>
                        </div>
                    </div>
                    <div id="port-diagnosis-container" class="diagnosis-container hidden"></div>
                </div>

                <!-- Boot Analysis -->
                <div class="diagnosis-section">
                    <div class="diagnosis-section-title"><span>BOOT STAGE ANALYSIS</span></div>
                    <div class="boot-analysis-grid">
                        <div class="analysis-col-method">
                            <label class="field-label sub">TEST METHOD</label>
                            <select id="test-method-select" class="mb-0">
                                <option value="battery">Battery Connected</option>
                                <option value="bench">Bench Power Supply (4.2V)</option>
                                <option value="bypass">10K Resistor Bypass</option>
                                <option value="no_battery">USB-C Input (No Battery)</option>
                            </select>
                        </div>
                        <div class="analysis-col-amps">
                            <label class="field-label sub">MEASURED VALUES (Volts / Amps)</label>
                            <div class="port-reading-inputs">
                                <input type="text" name="amp_draw" id="amp_draw_input"
                                    value="{{ unit.amp_draw if unit and unit.amp_draw else '' }}"
                                    placeholder="e.g. 15V/0.05A" class="mb-0 flex-1">
                                <button type="button" class="btn btn-sm btn-diag-analyze"
                                    onclick="analyzeBootStage()">ANALYZE</button>
                            </div>
                        </div>
                    </div>
                    <div id="boot-diagnosis-container" class="diagnosis-container hidden"></div>
                </div>

                <!-- Final State & Outcomes -->
                <div class="diagnosis-section result-section">
                    <div class="diagnosis-section-title result-header">
                        <span>RESULT & STATUS</span>
                    </div>
                    <div class="result-row">
                        <label class="field-label purple mb-0 flex-1">MODCHIP INSTALLED</label>
                        <select name="modchip_type" id="modchip-type" class="mb-0 flex-1-5">
                            <option value="">None</option>
                            <option value="Picofly" {% if unit and unit.modchip=='Picofly' %}selected{% endif %}>Picofly
                            </option>
                            <option value="SX Core" {% if unit and unit.modchip=='SX Core' %}selected{% endif %}>SX Core
                            </option>
                            <option value="Modchip" {% if unit and unit.modchip=='Modchip' %}selected{% endif %}>Generic
                            </option>
                        </select>
                    </div>
                    <div class="result-row border-top pt-3 mt-3">
                        <label class="field-label purple mb-0 flex-1">REPAIR STAGE</label>
                        <select name="status" class="mb-0 flex-1-5">
                            <option value="Received" {% if unit and unit.status=='Received' %}selected{% endif %}>
                                Received</option>
                            <option value="Diagnosing" {% if unit and unit.status=='Diagnosing' %}selected{% endif %}>
                                Diagnosing</option>
                            <option value="Waiting for Parts" {% if unit and unit.status=='Waiting for Parts'
                                %}selected{% endif %}>Waiting for Parts</option>
                            <option value="Repairing" {% if unit and unit.status=='Repairing' %}selected{% endif %}>
                                Repairing</option>
                            <option value="Testing" {% if unit and unit.status=='Testing' %}selected{% endif %}>Testing
                            </option>
                            <option value="Done" {% if unit and unit.status=='Done' %}selected{% endif %}>Done</option>
                            <option value="Sold" {% if unit and unit.status=='Sold' or unit.status=='Delivered'
                                %}selected{% endif %}>Sold</option>
                            <option value="Cancelled" {% if unit and unit.status=='Cancelled' %}selected{% endif %}>
                                Cancelled</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Right Column: Documentation Record -->
            <div class="documentation-column">
                <div class="diagnosis-section summary-group mt-0">
                    <div class="diagnosis-section-title">
                        <span>QUICK SUMMARY / TAGS</span>
                    </div>
                    <input type="text" name="condition_notes"
                        value="{{ unit.condition_notes if unit and unit.condition_notes else '' }}"
                        placeholder="e.g. Picofly, Needs Shell" class="mb-0">
                </div>

                <div class="diagnosis-section notes-group mt-0">
                    <div class="diagnosis-section-title">
                        <span>FULL REPAIR LOG & HISTORY</span>
                    </div>
                    <textarea name="notes" class="repair-log-container"
                        placeholder="Detailed history of repairs, parts replaced, and findings...">{{ unit.notes if unit else '' }}</textarea>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    // Visual Pin Tester Logic
    const pinInput = document.getElementById('pin_check_input');
    const visualTester = document.getElementById('visual-pin-tester');
    const toggleBtn = document.getElementById('toggle-grid-btn');
    const pinInputs = document.querySelectorAll('.pin-input');

    // Initial Load
    loadVisualData();
    updatePinPreview(); // Show summary on page load

    function togglePinTester() {
        if (visualTester.style.display === 'none') {
            // Open Grid
            visualTester.style.display = 'block';
            toggleBtn.textContent = 'CLOSE CHECKER';
            // Use Class for Styling
            toggleBtn.classList.add('btn-active-purple');
        } else {
            // Close Grid
            visualTester.style.display = 'none';
            toggleBtn.textContent = 'OPEN CHECKER';
            // Remove Class for Styling
            toggleBtn.classList.remove('btn-active-purple');
            saveVisualData();
        }
    }

    function loadVisualData() {
        let data = pinInput.value;
        if (!data) return;

        try {
            // Try parsing as JSON
            const jsonData = JSON.parse(data);

            // Populate Grid
            pinInputs.forEach(input => {
                const pin = input.dataset.pin;
                if (jsonData[pin]) {
                    input.value = jsonData[pin];
                    updatePinStyle(input);
                }
            });


            // Analyze
            analyzePins(jsonData);

            // Update Preview immediately (if grid is starting closed)
            updatePinPreview();

        } catch (e) {
            // Legacy Text - update summary
            const pinSummary = document.getElementById('pin-summary');
            if (pinSummary && pinInput.value) {
                pinSummary.innerHTML = `<span style="color: var(--accent-cyan);">${pinInput.value}</span>`;
            }
        }
    }

    function updatePinPreview() {
        const pinSummary = document.getElementById('pin-summary');
        if (!pinSummary) return;

        const data = pinInput.value ? JSON.parse(pinInput.value || '{}') : {};
        const expectedOL = [2, 3, 10, 11, 14, 15, 22, 23];

        let olPins = [];
        let shortPins = [];
        let hasData = false;
        let totalOLCount = 0;

        for (let pin = 1; pin <= 24; pin++) {
            const val = data[pin.toString()]; // JSON keys are strings
            if (val) {
                hasData = true;
                if (val === 'OL') {
                    totalOLCount++;
                    if (!expectedOL.includes(pin)) olPins.push(pin);
                }
                else if (isShort(val)) shortPins.push(pin);
            }
        }

        // Check if ripped off (20+ OL pins out of 24)
        if (totalOLCount >= 20) {
            pinSummary.innerHTML = `<strong style="color: #ff4444;">PORT RIPPED OFF</strong> <span style="color: #888;">(${totalOLCount} pins OL)</span>`;
            return;
        }

        if (!hasData) {
            // Check if legacy text logic applies
            if (!pinInput.value.trim().startsWith('{') && pinInput.value.trim().length > 0) {
                pinSummary.innerHTML = `<span style="color: var(--accent-cyan);">${pinInput.value}</span>`;
                return;
            }
            pinSummary.innerHTML = '<span style="color: #666;">No pin data</span>';
            return;
        }


        let html = '';
        if (olPins.length > 0) {
            html += `<div style="color: #ff4444;"><strong>OL:</strong> ${olPins.join(', ')}</div>`;
        }
        if (shortPins.length > 0) {
            html += `<div style="color: var(--accent-yellow);"><strong>SHORT:</strong> ${shortPins.join(', ')}</div>`;
        }
        if (olPins.length === 0 && shortPins.length === 0) {
            html += `<div style="color: var(--accent-green);"><strong>ALL PINS OK</strong> (Diode Mode)</div>`;
        }

        pinSummary.innerHTML = html || '<span style="color: #666;">No pin data</span>';
    }

    function updatePinStyle(input) {
        const val = input.value.toUpperCase();
        const pin = parseInt(input.dataset.pin);
        const expectedOL = [2, 3, 10, 11, 14, 15, 22, 23];

        if (val === 'OL') {
            if (expectedOL.includes(pin)) {
                input.style.color = 'var(--text-primary)';
                input.style.fontWeight = 'normal';
            } else {
                input.style.color = 'var(--pin-value-red)';
                input.style.fontWeight = 'bold';
            }
        } else if (val === 'GND' || val === '0.000') {
            input.style.color = 'var(--pin-value-cyan)';
        } else {
            input.style.color = 'var(--pin-value-green)';
        }
    }

    function saveVisualData() {
        let data = {};
        let hasData = false;
        pinInputs.forEach(input => {
            const val = input.value.trim();
            if (val) {
                data[input.dataset.pin] = val;
                hasData = true;
            }
        });


        if (hasData) {
            pinInput.value = JSON.stringify(data);
            analyzePins(data);
            updatePinPreview(); // Update the summary display
        } else {
            // If cleared, maybe clear input?
            // pinInput.value = "";
        }
    }

    function analyzePins(data) {
        const resultDiv = document.getElementById('auto-diagnosis-result');
        const resultText = document.getElementById('diagnosis-text');
        let findings = [];
        let olCount = 0;

        // Count OLs
        for (const key in data) {
            if (data[key] === 'OL') olCount++;
        }

        // Check for Ripped Off Port (Most/All pins OL)
        // If > 20 OLs, likely ripped off or major disconnect
        if (olCount > 20) {
            findings.push("USB-C Port likely Ripped Off / Disconnected");
        } else {
            // Pins A5(5), B5(17) are CC1/CC2
            if (isShort(data['5']) || isShort(data['17'])) {
                findings.push("Potential M92 IC Short (CC Lines - Pin 5/17)");
            }

            // D+ D- (P13USB) -> Pins 6, 7, 18, 19
            if (data['6'] === 'OL' || data['7'] === 'OL' || data['18'] === 'OL' || data['19'] === 'OL') {
                findings.push("Likely Broken Traces / Pads at USB-C Connector (Data Lines OL)");
            }

            // CC1/CC2 (M92) -> Pins 5, 20
            if (data['5'] === 'OL' || data['20'] === 'OL') {
                findings.push("Check M92 IC / USB-C Port (CC Lines OL)");
            }

            // SBU1/SBU2 (P13USB) -> Pins 8, 17
            if (data['8'] === 'OL' || data['17'] === 'OL') {
                findings.push("Check P13USB / Filters (SBU Lines OL)");
            }

            // VBUS Short -> Pin 4, 9, 16, 21
            if (isShort(data['4']) || isShort(data['9']) || isShort(data['16']) || isShort(data['21'])) {
                findings.push("VBUS Short (Check M92 / BQ / Caps)");
            }
        }

        if (findings.length > 0) {
            resultDiv.style.display = 'block';
            resultText.innerHTML = findings.join("<br>");
        } else {
            resultDiv.style.display = 'none';
        }
    }

    function isShort(val) {
        if (!val) return false;
        if (val.toUpperCase() === 'SHORT') return true;
        let num = parseFloat(val);
        if (!isNaN(num) && num > 0 && num < 0.050) return true;
        return false;
    }

    function setAllPinsGood() {
        if (visualTester.style.display === 'none') {
            togglePinTester(); // Ensure it's open
        }

        const goodValues = {
            1: 'GND', 2: 'OL', 3: 'OL', 4: '0.52', 5: '0.54', 6: '0.80', 7: '0.81', 8: '0.75', 9: '0.52', 10: 'OL', 11: 'OL', 12: 'GND',
            13: 'GND', 14: 'OL', 15: 'OL', 16: '0.52', 17: '0.75', 18: '0.81', 19: '0.80', 20: '0.54', 21: '0.52', 22: 'OL', 23: 'OL', 24: 'GND'
        };

        pinInputs.forEach(input => {
            const pin = parseInt(input.dataset.pin);
            if (goodValues[pin]) {
                input.value = goodValues[pin];
            }
            updatePinStyle(input);
        });
        saveVisualData();
        updatePinPreview(); // Update the summary display
    }

    // Attach listeners
    pinInputs.forEach(input => {
        input.addEventListener('input', () => {
            updatePinStyle(input);
            saveVisualData();
        });
        input.addEventListener('blur', () => {
            let val = input.value.toUpperCase();
            if (val === 'OL' || val === 'GND') {
                input.value = val;
                updatePinStyle(input);
                saveVisualData();
            }
        });
    });

    function autoLabel() {
        console.log("Auto Label Clicked");
        fetch('/api/next-label')
            .then(response => response.json())
            .then(data => {
                console.log("Next Label Response:", data);
                if (data.next_label) {
                    const labelInput = document.getElementById('labelInput');
                    labelInput.value = data.next_label;
                    // Flash effect
                    labelInput.style.backgroundColor = 'var(--accent-purple-soft)';
                    setTimeout(() => {
                        labelInput.style.backgroundColor = '';
                    }, 500);
                }
            })
            .catch(error => console.error('Error fetching next label:', error));
    }

    // Modchip checkbox toggle removed - handling via dropdown only

    // Boot Diagnosis Logic
    async function analyzePortReading() {
        const portVal = document.getElementById('usb_c_input').value.trim();
        const container = document.getElementById('port-diagnosis-container');

        if (!portVal) {
            alert('Please enter a port reading first');
            return;
        }

        container.innerHTML = '<div style="color: var(--text-dim); font-size: 0.8rem;">Analyzing Port...</div>';
        container.style.display = 'block';

        try {
            const res = await fetch('/api/diagnose-boot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    amp_draw: portVal,
                    test_method: 'no_battery'
                })
            });
            const data = await res.json();

            const severityColors = {
                'critical': 'var(--accent-red)',
                'high': 'var(--accent-orange)',
                'medium': 'var(--accent-yellow)',
                'low': 'var(--accent-cyan)',
                'none': 'var(--accent-green)'
            };

            const color = severityColors[data.severity] || 'var(--accent-purple)';
            const bg = (data.severity === 'none') ? 'rgba(10, 255, 10, 0.1)' : `rgba(255, 255, 255, 0.05)`;

            container.innerHTML = `
                <div class="diagnosis-card" style="--severity-color: ${color}; --severity-bg: ${bg}; border-left: 4px solid ${color};">
                    <div class="diagnosis-header">
                        <span class="diagnosis-title">Initial Port Analysis</span>
                        <span class="severity-badge">${data.severity}</span>
                    </div>
                    <div class="diagnosis-stage">${data.stage}</div>
                    <div class="diagnosis-fault">Likely: <strong>${data.fault}</strong></div>
                    <div class="diagnosis-action">${data.action}</div>
                    <button type="button" class="btn btn-copy-diag" onclick="copyDiagnosisToNotes('${data.stage}', '${data.fault}')">
                        COPY TO REPAIR LOG
                    </button>
                </div>
            `;
        } catch (err) {
            console.error(err);
            container.innerHTML = '<div style="color: var(--accent-red); font-size: 0.8rem;">Error analyzing port</div>';
        }
    }

    async function analyzeBootStage() {
        const ampVal = document.getElementById('amp_draw_input').value.trim();
        const method = document.getElementById('test-method-select').value;
        const container = document.getElementById('boot-diagnosis-container');

        if (!ampVal) {
            alert('Please enter an amp value first');
            return;
        }

        container.innerHTML = '<div style="color: var(--text-dim); font-size: 0.8rem;">Analyzing...</div>';
        container.style.display = 'block';

        try {
            const res = await fetch('/api/diagnose-boot', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    amp_draw: ampVal,
                    test_method: method
                })
            });
            const data = await res.json();

            const severityColors = {
                'critical': 'var(--accent-red)',
                'high': 'var(--accent-orange)',
                'medium': 'var(--accent-yellow)',
                'low': 'var(--accent-cyan)',
                'none': 'var(--accent-green)'
            };

            const severityBgs = {
                'critical': 'rgba(255, 68, 68, 0.2)',
                'high': 'rgba(255, 165, 0, 0.2)',
                'medium': 'rgba(255, 234, 0, 0.2)',
                'low': 'rgba(0, 243, 255, 0.2)',
                'none': 'rgba(10, 255, 10, 0.2)'
            };

            const color = severityColors[data.severity] || 'var(--accent-purple)';
            const bg = severityBgs[data.severity] || 'rgba(188, 19, 254, 0.1)';

            const methodDisplay = {
                'battery': 'BATTERY CONNECTED',
                'bench': 'BENCH POWER SUPPLY (4.2V)',
                'bypass': '10K RESISTOR BYPASS',
                'no_battery': 'USB-C INPUT (NO BATTERY)'
            };
            const methodLabel = methodDisplay[data.method_used] || data.method_used.toUpperCase();

            container.innerHTML = `
                <div class="diagnosis-card" style="--severity-color: ${color}; --severity-bg: ${bg}">
                    <div class="diagnosis-header">
                        <span class="diagnosis-title">Boot Analysis (${methodLabel})</span>
                        <span class="severity-badge">${data.severity}</span>
                    </div>
                    <div class="diagnosis-stage">${data.stage}</div>
                    <div class="diagnosis-fault">Likely: <strong>${data.fault}</strong></div>
                    <div class="diagnosis-action">${data.action}</div>
                    <button type="button" class="btn btn-copy-diag" onclick="copyDiagnosisToNotes('${data.stage}', '${data.fault}')">
                        COPY TO REPAIR LOG
                    </button>
                </div>
            `;
        } catch (err) {
            console.error(err);
            container.innerHTML = '<div style="color: var(--accent-red); font-size: 0.8rem;">Error analyzing boot stage</div>';
        }
    }

    function copyDiagnosisToNotes(stage, fault) {
        const notesArea = document.getElementsByName('notes')[0];
        const date = new Date().toLocaleDateString();
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const diagText = `\n[${date} ${timestamp}] Diagnostic: ${stage} - Likely Fault: ${fault}`;

        notesArea.value += diagText;
        // Scroll to bottom
        notesArea.scrollTop = notesArea.scrollHeight;

        // Visual feedback on button
        const btn = document.querySelector('.btn-copy-diag');
        const originalText = btn.textContent;
        btn.textContent = 'COPIED!';
        btn.classList.add('btn-success');

        setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove('btn-success');
        }, 1500);
    }
</script>
{% endblock %}