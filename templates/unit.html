{% extends 'base.html' %}

{% block head %}
<style>
    #modchip-type:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="unit-nav-bar">
    <a href="/" class="btn">&larr; Back to Dashboard</a>
</div>

<div class="glass-card">
    <form method="POST">
        <div class="unit-header-container">
            <div>
                <h1 class="barcode-text">{{ barcode }}</h1>
                <div class="registration-info">
                    {% if unit and unit.patch_status %}
                    {% set status_class = 'security-badge unknown' %}
                    {% if unit.patch_status == 'Unpatched' %}{% set status_class = 'security-badge unpatched' %}
                    {% elif unit.patch_status == 'Patched' %}{% set status_class = 'security-badge patched' %}{% endif
                    %}
                    <span class="{{ status_class }}">
                        {{ unit.patch_status.upper() }}
                    </span>
                    {% endif %}
                    <span>
                        {% if unit %}
                        Registered: {{ unit.created_at }}
                        {% else %}
                        Draft Entry
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="header-actions">
                <!-- Status tag removed to avoid redundancy with footer dropdown -->
                <button type="submit" class="btn btn-primary btn-lg">
                    {% if unit and unit.id %}Update Unit{% else %}Register Unit{% endif %}
                </button>
            </div>
        </div>
        <div class="grid-2">
            <!-- Left Column: Unit Identity & Active Triage -->
            <div>
                <!-- Identity Group -->
                <div class="diagnosis-section identity-section">
                    <div class="diagnosis-section-title identity-header">
                        <span>UNIT IDENTITY</span>
                    </div>

                    <div class="identity-grid">
                        <div class="form-group mb-0">
                            <label class="field-label">Board Label / ID</label>
                            <div class="label-row">
                                <input type="text" name="label" id="labelInput"
                                    value="{{ unit['label'] if unit and unit['label'] else '' }}"
                                    placeholder="e.g. SW001" class="mb-0 flex-1">
                                <button type="button" class="btn btn-sm btn-accent-purple"
                                    onclick="autoLabel()">AUTO</button>
                            </div>
                        </div>
                        <div class="form-group mb-0">
                            <label class="field-label">Owner / Source</label>
                            <input type="text" name="owner" placeholder="Owner or Source"
                                value="{{ unit.owner if unit and unit.owner else '' }}" class="mb-0">
                        </div>
                        <div class="form-group mb-0">
                            <label class="field-label">Device Model</label>
                            <div class="model-row">
                                <select name="type" class="flex-1 mb-0">
                                    <option value="Console" {% if not unit or unit.type=='Console' %}selected{% endif
                                        %}>Console</option>
                                    <option value="Dock" {% if unit and unit.type=='Dock' %}selected{% endif %}>Dock
                                    </option>
                                    <option value="Accessory" {% if unit and unit.type=='Accessory' %}selected{% endif
                                        %}>Accessory</option>
                                </select>
                                <input type="text" name="model" value="{{ unit.model if unit else 'Nintendo Switch' }}"
                                    placeholder="e.g. Switch V2" class="flex-2 mb-0">
                            </div>
                        </div>
                        <div class="form-group mb-0">
                            <label class="field-label">Reported Issue</label>
                            <input type="text" name="issue" value="{{ unit.issue if unit and unit.issue else '' }}"
                                placeholder="Fault symptom" class="mb-0">
                        </div>
                    </div>


                </div>

                <!-- Diagnostic Suite -->
                <!-- USB-C Pin Check -->
                <div class="diagnosis-section">
                    <div class="diagnosis-section-title">
                        <span>USB-C PIN CHECK</span>
                        <div class="pin-actions">
                            <button type="button" class="btn btn-sm btn-accent-green" onclick="setAllPinsGood()">SET
                                GOOD</button>
                            <button type="button" id="toggle-grid-btn" class="btn btn-sm"
                                onclick="togglePinTester()">OPEN CHECKER</button>
                        </div>
                    </div>

                    <input type="hidden" name="pin_check" id="pin_check_input"
                        value="{{ unit.pin_check if unit and unit.pin_check else '' }}">

                    <div id="pin-summary" class="pin-summary-box">
                        <span class="text-dim-small">No pin data</span>
                    </div>

                    <!-- Visual Grid (Hidden by default) -->
                    <div id="visual-pin-tester" class="visual-pin-tester" style="display: none;">
                        <div class="tester-header">
                            <span class="tester-title">MECHANIC TESTER MODE</span>
                        </div>

                        <div class="pin-grid-columns">
                            <!-- Side A -->
                            <div class="pin-column">
                                {% set pin_labels_a = {1:'GND', 2:'TX1+', 3:'TX1-', 4:'VBUS', 5:'CC1', 6:'D+', 7:'D-',
                                8:'SBU1', 9:'VBUS', 10:'RX2-', 11:'RX2+', 12:'GND'} %}
                                {% for i in range(1, 13) %}
                                <div class="pin-row">
                                    <div class="pin-label-group">
                                        <span class="pin-num">{% if i < 10 %}0{% endif %}{{i}}</span>
                                                <span class="pin-name">{{ pin_labels_a[i] }}</span>
                                    </div>
                                    <input type="text" class="pin-input pin-input-right" data-pin="{{i}}" maxlength="5"
                                        placeholder="---">
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Side B -->
                            <div class="pin-column">
                                {% set pin_labels_b = {13:'GND', 14:'RX1+', 15:'RX1-', 16:'VBUS', 17:'SBU2', 18:'D-',
                                19:'D+', 20:'CC2', 21:'VBUS', 22:'TX2-', 23:'TX2+', 24:'GND'} %}
                                {% for i in range(13, 25) %}
                                <div class="pin-row">
                                    <input type="text" class="pin-input pin-input-left" data-pin="{{i}}" maxlength="5"
                                        placeholder="---">
                                    <div class="pin-label-group">
                                        <span class="pin-name text-right">{{ pin_labels_b[i] }}</span>
                                        <span class="pin-num text-right">{{i}}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Automated Pin Diagnosis Result (Hidden by default) -->
                <div id="auto-diagnosis-result" class="diagnosis-card hidden mt-3 border-orange">
                    <div class="diagnosis-header border-bottom-dim pb-2 mb-2">
                        <span class="diagnosis-title text-orange">⚠️ PIN ANALYSIS
                            FINDINGS</span>
                    </div>
                    <div id="diagnosis-text" class="text-body-sm">
                    </div>
                </div>

                <!-- Port Reading -->
                <div class="diagnosis-section">
                    <div class="diagnosis-section-title"><span>PORT READING (INITIAL)</span></div>
                    <div class="form-group mb-0">
                        <label class="field-label sub">NO BATTERY IDLE MEASUREMENT</label>
                        <div class="port-reading-inputs">
                            <input type="text" name="usb_c_reading" id="usb_c_input"
                                value="{{ unit['usb_c_reading'] if unit and unit['usb_c_reading'] else '' }}"
                                placeholder="e.g. 15V/0.45A" class="mb-0 flex-1">
                            <button type="button" class="btn btn-sm btn-diag-analyze"
                                onclick="analyzePortReading()">ANALYZE</button>
                        </div>
                    </div>
                    <div id="port-diagnosis-container" class="diagnosis-container hidden"></div>
                </div>

                <!-- Boot Analysis -->
                <div class="diagnosis-section">
                    <div class="diagnosis-section-title"><span>BOOT STAGE ANALYSIS</span></div>
                    <div class="boot-analysis-grid">
                        <div class="analysis-col-method">
                            <label class="field-label sub">TEST METHOD</label>
                            <select id="test-method-select" class="mb-0" onchange="updateMethodDescription()">
                                <optgroup label="USB-C Analysis">
                                    <option value="no_battery">USB-C Input (No Battery)</option>
                                    <option value="battery">USB-C Battery Connected</option>
                                </optgroup>
                                <optgroup label="Bench Diagnostics (Requires Soldering)">
                                    <option value="bench">First Stage Boot (VSYS Injection)</option>
                                    <option value="bypass">Second Stage Boot (VBAT + 10K)</option>
                                </optgroup>
                            </select>
                            <div id="method-description" class="method-instructions hidden"></div>
                        </div>
                        <div class="analysis-col-amps">
                            <label class="field-label sub">MEASURED VALUES (Volts / Amps)</label>
                            <div class="port-reading-inputs">
                                <input type="text" name="amp_draw" id="amp_draw_input"
                                    value="{{ unit.amp_draw if unit and unit.amp_draw else '' }}"
                                    placeholder="e.g. 15V/0.05A" class="mb-0 flex-1">
                                <button type="button" class="btn btn-sm btn-diag-analyze"
                                    onclick="analyzeBootStage()">ANALYZE</button>
                            </div>
                        </div>
                    </div>
                    <div id="boot-diagnosis-container" class="diagnosis-container hidden"></div>
                </div>

                <!-- Final State & Outcomes -->
                <div class="diagnosis-section result-section">
                    <div class="diagnosis-section-title result-header">
                        <span>RESULT & STATUS</span>
                    </div>
                    <div class="result-row">
                        <label class="field-label purple mb-0 flex-1">MODCHIP INSTALLED</label>
                        <select name="modchip_type" id="modchip-type" class="mb-0 flex-1-5">
                            <option value="">None</option>
                            <option value="Picofly" {% if unit and unit.modchip=='Picofly' %}selected{% endif %}>Picofly
                            </option>
                            <option value="SX Core" {% if unit and unit.modchip=='SX Core' %}selected{% endif %}>SX Core
                            </option>
                            <option value="Modchip" {% if unit and unit.modchip=='Modchip' %}selected{% endif %}>Generic
                            </option>
                        </select>
                    </div>
                    <div class="result-row border-top pt-3 mt-3">
                        <label class="field-label purple mb-0 flex-1">REPAIR STAGE</label>
                        <select name="status" class="mb-0 flex-1-5">
                            <option value="Received" {% if unit and unit.status=='Received' %}selected{% endif %}>
                                Received</option>
                            <option value="Diagnosing" {% if unit and unit.status=='Diagnosing' %}selected{% endif %}>
                                Diagnosing</option>
                            <option value="Waiting for Parts" {% if unit and unit.status=='Waiting for Parts'
                                %}selected{% endif %}>Waiting for Parts</option>
                            <option value="Repairing" {% if unit and unit.status=='Repairing' %}selected{% endif %}>
                                Repairing</option>
                            <option value="Testing" {% if unit and unit.status=='Testing' %}selected{% endif %}>Testing
                            </option>
                            <option value="Done" {% if unit and unit.status=='Done' %}selected{% endif %}>Done</option>
                            <option value="Sold" {% if unit and unit.status=='Sold' or unit.status=='Delivered'
                                %}selected{% endif %}>Sold</option>
                            <option value="Cancelled" {% if unit and unit.status=='Cancelled' %}selected{% endif %}>
                                Cancelled</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Right Column: Documentation Record -->
            <div class="documentation-column">
                <div class="diagnosis-section summary-group mt-0">
                    <div class="diagnosis-section-title">
                        <span>QUICK SUMMARY / TAGS</span>
                    </div>
                    <input type="text" name="condition_notes"
                        value="{{ unit.condition_notes if unit and unit.condition_notes else '' }}"
                        placeholder="e.g. Picofly, Needs Shell" class="mb-0">
                </div>

                <div class="diagnosis-section notes-group mt-0">
                    <div class="diagnosis-section-title">
                        <span>FULL REPAIR LOG & HISTORY</span>
                    </div>
                    <textarea name="notes" class="repair-log-container"
                        placeholder="Detailed history of repairs, parts replaced, and findings...">{{ unit.notes if unit else '' }}</textarea>
                </div>
            </div>
        </div>
    </form>
</div>

<script src="{{ url_for('static', filename='unit.js') }}"></script>
{% endblock %}